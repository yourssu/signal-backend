### Generate my referral code (default)
POST {{host}}/api/referrals/my-code
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "customCode": "test"
}

> {%
    client.test("Referral code generated successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.result !== undefined, "Result is missing");
        client.assert(response.body.result.referralCode !== undefined, "Referral code is missing");
        client.assert(typeof response.body.result.referralCode === "string", "Referral code should be string");
    });
    
    // Store referral code for potential future use
    client.global.set("myReferralCode", response.body.result.referralCode);
%}

### Expected Response:
# 200 OK
# {
#   "timestamp": "2025-04-27T12:16:55.043588+09:00",
#   "result": {
#     "referralCode": "ABCD1234"
#   }
# }

###

### Generate my referral code with custom code
POST {{host}}/api/referrals/my-code
Content-Type: application/json
Authorization: Bearer {{devAccessToken}}

{
  "customCode": "MY_CUSTOM_CODE_2024"
}

> {%
    client.test("Custom referral code generated successfully", function() {
        client.assert(response.status === 200, "Response status is not 200");
        client.assert(response.body.result !== undefined, "Result is missing");
        client.assert(response.body.result.referralCode === "MY_CUSTOM_CODE_2024", "Custom referral code not matched");
    });
%}

### Expected Response:
# 200 OK
# {
#   "timestamp": "2025-04-27T12:16:55.043588+09:00",
#   "result": {
#     "referralCode": "MY_CUSTOM_CODE_2024"
#   }
# }

###

### Generate referral code without authentication (should fail)
POST {{host}}/api/referrals/my-code
Content-Type: application/json

{
  "customCode": null
}

> {%
    client.test("Authentication required", function() {
        client.assert(response.status === 401, "Expected 401 Unauthorized");
    });
%}

### Expected Response:
# 401 Unauthorized
# {
#   "error": "Unauthorized",
#   "message": "Authentication required"
# }

###

### Generate referral code with invalid custom code (should fail)
POST {{host}}/api/referrals/my-code
Content-Type: application/json
Authorization: Bearer {{devAccessToken}}

{
  "customCode": "invalid code with spaces!"
}

> {%
    client.test("Invalid custom code rejected", function() {
        client.assert(response.status === 400, "Expected 400 Bad Request");
    });
%}

### Expected Response:
# 400 Bad Request
# {
#   "error": "Invalid request parameters",
#   "message": "Custom code must be alphanumeric"
# }

###

### Generate duplicate referral code (should fail on second attempt)
POST {{host}}/api/referrals/my-code
Content-Type: application/json
Authorization: Bearer {{devAccessToken}}

{
  "customCode": "DUPLICATE_CODE_TEST"
}

> {%
    client.test("First attempt should succeed", function() {
        client.assert(response.status === 200, "First attempt should be 200");
    });
%}

###

### Try to generate the same custom code again (should fail)
POST {{host}}/api/referrals/my-code
Content-Type: application/json
Authorization: Bearer {{devAccessToken}}

{
  "customCode": "DUPLICATE_CODE_TEST"
}

> {%
    client.test("Duplicate code should be rejected", function() {
        client.assert(response.status === 409, "Expected 409 Conflict for duplicate code");
    });
%}

### Expected Response:
# 409 Conflict
# {
#   "error": "Duplicate referral code",
#   "message": "The referral code already exists"
# }
